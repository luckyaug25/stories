<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Story</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="Logo.png">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #0a0a0a;
      color: white;
    }

    .story-form input,
    .story-form textarea {
      background: #000;
      border: 2px solid #222;
      color: #fff;
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }

    #mediaPreview img,
    #mediaPreview video,
    #mediaPreview iframe {
      width: 100%;
      max-height: 50vh;
      object-fit: contain;
      border: 2px solid #222;
    }

    .modal-content {
      background-color: #000;
      padding: 20px;
      border: 2px solid #222;
      width: 80%;
      max-width: 600px;
      box-sizing: border-box;
    }

    /* Remove hover & border-radius globally */
    button, a {
      border-radius: 0 !important;
      transition: none !important;
    }

    /* Buttons colors */
    .btn-blue { background-color: #007bff; border: 2px solid #007bff; color: white; }
    .btn-green { background-color: #00a65a; border: 2px solid #00a65a; color: white; }
    .btn-red { background-color: #d9534f; border: 2px solid #d9534f; color: white; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">

  <div class="max-w-3xl w-full bg-black p-6 border-2 border-gray-800 shadow-2xl">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-8 text-center leading-tight">
      Edit Story
    </h1>

    <form id="editStoryForm" class="story-form flex flex-col gap-4">
      <input type="text" id="title" placeholder="Story Title" required>
      <textarea id="content" placeholder="Update your story here..." rows="10" required class="resize-y"></textarea>
      
      <div class="buttons flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
        <button type="button" onclick="openPopup()" class="btn-green w-full sm:w-auto py-3 px-8 font-bold">
          âž• Insert Media
        </button>
        <button type="submit" class="btn-blue w-full sm:w-auto py-3 px-8 font-bold">
          Update Story
        </button>
      </div>
    </form>
  </div>

  <!-- Media Modal -->
  <div id="mediaModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-4 z-50 hidden">
    <div class="modal-content">
      <h3 class="text-2xl font-semibold text-white mb-4">Insert Image / Video / GIF</h3>
      <input type="text" id="mediaURL" placeholder="Paste media link here">
      <div id="mediaPreview" class="mb-4 p-2 bg-black min-h-[100px] flex justify-center items-center"></div>
      <div class="flex flex-col sm:flex-row justify-end space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
        <button type="button" onclick="insertMediaFromPopup()" class="btn-blue w-full sm:w-auto py-2 px-6 font-bold">
          Insert
        </button>
        <button type="button" onclick="closePopup()" class="btn-red w-full sm:w-auto py-2 px-6 font-bold">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script defer>
    const storyId = new URLSearchParams(location.search).get('id');

    async function fetchStory() {
      try {
        const response = await fetch(`/api/stories/${storyId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const story = await response.json();
        document.getElementById('title').value = story.title;
        document.getElementById('content').value = story.content;
      } catch (error) {
        console.error('Failed to fetch story:', error);
        showCustomMessage("Failed to load story. Please try again later.", "error");
      }
    }

    function showCustomMessage(message, type = "info") {
      const existing = document.getElementById('custom-message-box');
      if (existing) existing.remove();

      const box = document.createElement('div');
      box.id = 'custom-message-box';
      box.className = `fixed top-4 right-4 p-4 text-white text-lg font-semibold shadow-lg z-[100]`;
      box.textContent = message;
      if (type === "error") box.classList.add('btn-red');
      else if (type === "success") box.classList.add('btn-green');
      else box.classList.add('btn-blue');
      document.body.appendChild(box);

      setTimeout(() => {
        box.remove();
      }, 3000);
    }

    function openPopup() {
      document.getElementById("mediaModal").style.display = "flex";
      document.getElementById("mediaURL").value = "";
      document.getElementById("mediaPreview").innerHTML = "";
    }

    function closePopup() {
      document.getElementById("mediaModal").style.display = "none";
    }

    document.getElementById("mediaURL").addEventListener("input", function () {
      const url = this.value;
      let previewHTML = "";

      if (url.match(/\.(jpeg|jpg|png|gif|webp)$/i)) {
        previewHTML = `<img src="${url}" alt="Preview">`;
      } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
        previewHTML = `<video autoplay muted loop><source src="${url}"></video>`;
      } else if (url.includes("youtube.com/watch?v=") || url.includes("youtu.be/")) {
        const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
        if (videoId) previewHTML = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
      }

      document.getElementById("mediaPreview").innerHTML = previewHTML;
    });

    function insertMediaFromPopup() {
      const url = document.getElementById('mediaURL').value;
      const contentField = document.getElementById('content');
      if (!url) return showCustomMessage("Please enter a media URL.", "error");

      let mediaTag = '';
      if (url.match(/\.(jpeg|jpg|png|gif|webp)$/i)) mediaTag = `<img src="${url}" style="width:100%; margin:10px 0;">`;
      else if (url.match(/\.(mp4|webm|ogg)$/i)) mediaTag = `<video src="${url}" autoplay muted loop style="width:100%; margin:10px 0;"></video>`;
      else if (url.includes("youtube.com/watch?v=") || url.includes("youtu.be/")) {
        const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
        if (videoId) mediaTag = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="margin:10px 0;"></iframe>`;
        else return showCustomMessage("Invalid YouTube URL.", "error");
      } else return showCustomMessage("Unsupported media type!", "error");

      const start = contentField.selectionStart;
      const end = contentField.selectionEnd;
      contentField.value = contentField.value.substring(0, start) + mediaTag + contentField.value.substring(end);
      closePopup();
    }

    document.getElementById('editStoryForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const updatedTitle = document.getElementById('title').value.trim();
      const updatedContent = document.getElementById('content').value.trim();
      if (!updatedTitle || !updatedContent) return showCustomMessage("Title and content are required.", "error");

      try {
        const res = await fetch(`/api/stories/${storyId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: updatedTitle, content: updatedContent })
        });
        if (res.ok) {
          showCustomMessage("Story updated successfully!", "success");
          setTimeout(() => window.location.href = '/manage', 1500);
        } else {
          showCustomMessage("Failed to update the story.", "error");
        }
      } catch (err) {
        console.error(err);
        showCustomMessage("Error updating story.", "error");
      }
    });

    window.onload = fetchStory;
  </script>
</body>
</html>
